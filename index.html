<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- Ensure compatibility with IE -->
    <meta name="theme-color" content="#ff69b4"> <!-- Set theme color for Chrome on Android -->
    <meta name="application-name" content="Budget App"> <!-- Ensure compatibility with Google Chrome -->
    <meta name="description" content="A simple budget management app"> <!-- Ensure compatibility with Google Chrome -->
    <meta name="mobile-web-app-capable" content="yes"> <!-- Enable web app mode on mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes"> <!-- Enable web app mode on iOS -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!-- Set status bar style on iOS -->
    <meta name="apple-mobile-web-app-title" content="Budget App"> <!-- Set web app title on iOS -->
    <link rel="apple-touch-icon" href="icons/icon-192x192.png"> <!-- Set app icon for iOS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css"> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> <!-- Add Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Add Chart.js -->
    <link rel="manifest" href="manifest.json"> <!-- Link to the manifest file -->
    <script src="indexeddb.js"></script> <!-- Add IndexedDB script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ics/2.20.0/ics.min.js"></script> <!-- Add ics library -->
    <title>Budget App</title>
</head>
<body>
    <!-- Dark Mode Toggle -->
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">
        <i class="fas fa-moon"></i>
    </button>

    <!-- PWA Install Banner -->
    <div id="pwa-install-banner" class="pwa-install-banner" style="display: none;">
        <div class="install-banner-content">
            <div class="install-icon">
                <i class="fas fa-mobile-alt"></i>
            </div>
            <div class="install-text">
                <h3>Add to Home Screen</h3>
                <p>Install our app for the best experience!</p>
            </div>
            <div class="install-actions">
                <button id="install-btn" class="btn-primary">Install</button>
                <button id="dismiss-btn" class="btn-secondary">Not Now</button>
            </div>
        </div>
    </div>

    <div id="app">
        <header class="app-header">
            <h1>Budget Expense Tracker</h1>
        </header>

        <!-- Dashboard Page -->
        <main v-show="currentPage === 'dashboard'" class="page-content">
            <!-- Budget Section -->
            <section class="card budget-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h2 class="card-title">Set Your Budget</h2>
                </div>
                <div class="card-content">
                    <form @submit.prevent="setBudget" class="budget-form">
                        <div class="input-group">
                            <label for="budget" class="input-label">Monthly Budget Amount</label>
                            <div class="input-wrapper">
                                <span class="input-prefix">$</span>
                                <input type="number" id="budget" v-model="budget" placeholder="0.00" step="0.01" required class="form-input">
                            </div>
                        </div>
                        <button type="submit" class="btn-primary btn-full">
                            <i class="fas fa-save"></i>
                            Set Budget
                        </button>
                    </form>
                </div>
            </section>

            <!-- Summary Cards Grid -->
            <div class="summary-grid">
                <!-- Financial Summary -->
                <section class="card summary-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h2 class="card-title">Financial Summary</h2>
                    </div>
                    <div class="card-content">
                        <div class="summary-items">
                            <div class="summary-item">
                                <span class="summary-label">Budget</span>
                                <span class="summary-value text-primary">${{ budget }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Expenses</span>
                                <span class="summary-value text-danger">${{ totalExpenses }}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Remaining Balance</span>
                                <span class="summary-value" :class="remainingBalance >= 0 ? 'text-success' : 'text-danger'">
                                    ${{ remainingBalance }}
                                </span>
                            </div>
                        </div>
                        <div class="deduction-breakdown">
                            <h3 class="breakdown-title">Expense Breakdown</h3>
                            <div class="breakdown-items">
                                <div class="breakdown-item">
                                    <span>Weekly</span>
                                    <span>${{ deductions.weekly }}</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Fortnightly</span>
                                    <span>${{ deductions.fortnightly }}</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Monthly</span>
                                    <span>${{ deductions.monthly }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Next Deduction -->
                <section class="card next-deduction-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h2 class="card-title">Next Deduction</h2>
                    </div>
                    <div class="card-content">
                        <div v-if="nextDeduction.name" class="next-deduction-content">
                            <div class="deduction-detail">
                                <span class="detail-label">Expense</span>
                                <span class="detail-value">{{ nextDeduction.name }}</span>
                            </div>
                            <div class="deduction-detail">
                                <span class="detail-label">Amount</span>
                                <span class="detail-value text-danger">${{ nextDeduction.amount }}</span>
                            </div>
                            <div class="deduction-detail">
                                <span class="detail-label">Frequency</span>
                                <span class="detail-value">{{ nextDeduction.frequency }}</span>
                            </div>
                            <div class="deduction-detail">
                                <span class="detail-label">Day</span>
                                <span class="detail-value">{{ nextDeduction.day }}</span>
                            </div>
                            <div class="next-due-highlight">
                                <i class="fas fa-clock"></i>
                                <span>{{ nextDeduction.nextDueDate }}</span>
                            </div>
                        </div>
                        <div v-else class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-calendar-times"></i>
                            </div>
                            <p class="empty-text">No upcoming deductions</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <!-- Expenses Page -->
        <main v-show="currentPage === 'expenses'" class="page-content">
            <!-- Add/Edit Expense Form -->
            <section class="card expense-form-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <h2 class="card-title">{{ isEditing ? 'Edit Expense' : 'Add New Expense' }}</h2>
                </div>
                <div class="card-content">
                    <form @submit.prevent="addExpense" class="expense-form">
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="expense-name" class="input-label">Expense Name</label>
                                <input type="text" id="expense-name" v-model="newExpense.name" placeholder="e.g., Groceries, Rent, Utilities" required class="form-input">
                            </div>
                            <div class="input-group">
                                <label for="expense-amount" class="input-label">Amount</label>
                                <div class="input-wrapper">
                                    <span class="input-prefix">$</span>
                                    <input type="number" id="expense-amount" v-model="newExpense.amount" placeholder="0.00" step="0.01" required class="form-input">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="expense-frequency" class="input-label">Frequency</label>
                                <select id="expense-frequency" v-model="newExpense.frequency" class="form-input">
                                    <option value="weekly">Weekly</option>
                                    <option value="fortnightly">Fortnightly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="expense-category" class="input-label">Category</label>
                                <select id="expense-category" v-model="newExpense.category" class="form-input">
                                    <option v-for="category in expenseCategories" :value="category.id" :key="category.id">
                                        {{ category.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="expense-start-date" class="input-label">Start Date</label>
                                <input type="date" id="expense-start-date" v-model="newExpense.startDate" class="form-input">
                            </div>
                            <div class="input-group">
                                <label for="expense-day" class="input-label">Day of Week</label>
                                <select id="expense-day" v-model="newExpense.day" class="form-input">
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                    <option value="saturday">Saturday</option>
                                    <option value="sunday">Sunday</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn-success btn-full">
                            <i class="fas fa-plus"></i>
                            {{ isEditing ? 'Update Expense' : 'Add Expense' }}
                        </button>
                    </form>
                </div>
            </section>

            <!-- Expenses List -->
            <section class="card expenses-list-card">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <h2 class="card-title">Your Expenses</h2>
                </div>
                <div class="card-content">
                    <!-- Search and Filter Section -->
                    <div v-if="expenses.length > 0" class="filters-section">
                        <div class="filter-grid">
                            <div class="input-group">
                                <label for="search-expenses" class="input-label">Search</label>
                                <input type="text" id="search-expenses" v-model="searchQuery" placeholder="Search expenses..." class="form-input">
                            </div>
                            <div class="input-group">
                                <label for="filter-category" class="input-label">Category</label>
                                <select id="filter-category" v-model="categoryFilter" class="form-input">
                                    <option value="">All Categories</option>
                                    <option v-for="category in expenseCategories" :value="category.id" :key="category.id">
                                        {{ category.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="filter-frequency" class="input-label">Frequency</label>
                                <select id="filter-frequency" v-model="frequencyFilter" class="form-input">
                                    <option value="">All Frequencies</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="fortnightly">Fortnightly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="sort-by" class="input-label">Sort By</label>
                                <select id="sort-by" v-model="sortBy" class="form-input">
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="amount-desc">Highest Amount</option>
                                    <option value="amount-asc">Lowest Amount</option>
                                    <option value="name-asc">Name A-Z</option>
                                    <option value="name-desc">Name Z-A</option>
                                </select>
                            </div>
                        </div>
                        <div class="filter-footer">
                            <button @click="clearFilters" class="btn-secondary">
                                <i class="fas fa-times"></i>
                                Clear Filters
                            </button>
                            <span class="filter-count">{{ filteredExpenses.length }} of {{ expenses.length }} expenses</span>
                        </div>
                    </div>

                    <!-- Empty States -->
                    <div v-if="filteredExpenses.length === 0 && expenses.length > 0" class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="empty-title">No matching expenses</h3>
                        <p class="empty-text">Try adjusting your filters or search terms.</p>
                        <button @click="clearFilters" class="btn-secondary">Clear Filters</button>
                    </div>
                    <div v-else-if="expenses.length === 0" class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-inbox"></i>
                        </div>
                        <h3 class="empty-title">No expenses yet</h3>
                        <p class="empty-text">Add your first expense using the form above.</p>
                    </div>

                    <!-- Expenses List -->
                    <div v-else class="expenses-list">
                        <div v-for="(expense, index) in filteredExpenses" :key="expense.name + index" class="expense-card">
                            <div class="expense-header">
                                <div class="expense-icon" :style="{ backgroundColor: getCategoryById(expense.category).color }">
                                    <i :class="getCategoryById(expense.category).icon"></i>
                                </div>
                                <div class="expense-main">
                                    <h3 class="expense-name">{{ expense.name }}</h3>
                                    <div class="expense-meta">
                                        <span class="category-tag" :style="{ backgroundColor: getCategoryById(expense.category).color }">
                                            {{ getCategoryById(expense.category).name }}
                                        </span>
                                        <span class="frequency-tag">
                                            <i class="fas fa-calendar-alt"></i>
                                            {{ expense.frequency }}
                                        </span>
                                        <span class="day-tag">
                                            <i class="fas fa-calendar-day"></i>
                                            {{ expense.day }}
                                        </span>
                                    </div>
                                </div>
                                <div class="expense-amount">
                                    <span class="amount-value">${{ expense.amount }}</span>
                                </div>
                            </div>
                            <div v-if="expense.startDate" class="expense-footer">
                                <span class="start-date">
                                    <i class="fas fa-calendar"></i>
                                    Started {{ formatDate(expense.startDate) }}
                                </span>
                            </div>
                            <div class="expense-actions">
                                <button @click="editExpense(index)" class="btn-icon btn-warning">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @click="deleteExpense(index)" class="btn-icon btn-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div v-if="expenses.length > 0" class="action-buttons">
                        <button @click="calculateTotalExpenses" class="btn-primary">
                            <i class="fas fa-calculator"></i>
                            Calculate Totals
                        </button>
                        <button @click="exportToCSV" class="btn-success">
                            <i class="fas fa-download"></i>
                            Export CSV
                        </button>
                        <label for="csv-import" class="btn-secondary">
                            <i class="fas fa-upload"></i>
                            Import CSV
                        </label>
                        <input type="file" id="csv-import" accept=".csv" @change="importFromCSV" style="display: none;">
                        <button @click="backupData" class="btn-info">
                            <i class="fas fa-save"></i>
                            Backup Data
                        </button>
                        <button @click="clearAllExpenses" class="btn-danger">
                            <i class="fas fa-trash-alt"></i>
                            Clear All
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Analytics Page -->
        <main v-show="currentPage === 'analytics'" class="page-content">
            <!-- Analytics Content -->
            <section v-if="expenses.length > 0" class="analytics-section">
                <!-- Charts Grid -->
                <div class="charts-grid">
                    <!-- Category Breakdown Pie Chart -->
                    <section class="card chart-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <h2 class="card-title">Expenses by Category</h2>
                        </div>
                        <div class="card-content">
                            <div class="chart-wrapper">
                                <canvas id="categoryChart"></canvas>
                            </div>
                        </div>
                    </section>

                    <!-- Frequency Breakdown Bar Chart -->
                    <section class="card chart-card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h2 class="card-title">Expenses by Frequency</h2>
                        </div>
                        <div class="card-content">
                            <div class="chart-wrapper">
                                <canvas id="frequencyChart"></canvas>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Budget vs Actual Comparison -->
                <section v-if="budget > 0" class="card budget-comparison-card">
                    <div class="card-header">
                        <div class="card-icon">
                            <i class="fas fa-balance-scale"></i>
                        </div>
                        <h2 class="card-title">Budget vs Actual Spending</h2>
                    </div>
                    <div class="card-content">
                        <div class="budget-progress">
                            <div class="progress-bar">
                                <div class="progress-fill budget-fill" :style="{ width: budgetPercentage + '%' }"></div>
                                <div class="progress-fill actual-fill" :style="{ width: actualPercentage + '%' }"></div>
                            </div>
                            <div class="progress-labels">
                                <span class="progress-label">
                                    <span class="label-dot budget-dot"></span>
                                    Budget: ${{ budget }}
                                </span>
                                <span class="progress-label">
                                    <span class="label-dot actual-dot"></span>
                                    Spent: ${{ totalExpenses }}
                                </span>
                            </div>
                        </div>
                        <div class="budget-stats">
                            <div class="stat-item">
                                <span class="stat-label">Remaining</span>
                                <span class="stat-value" :class="remainingBalance >= 0 ? 'text-success' : 'text-danger'">
                                    ${{ remainingBalance }}
                                </span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Utilization</span>
                                <span class="stat-value">{{ Math.round((totalExpenses / budget) * 100) }}%</span>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Empty State -->
            <section v-else class="empty-analytics">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h2 class="empty-title">No Analytics Yet</h2>
                    <p class="empty-text">Add some expenses to see detailed analytics and insights about your spending patterns.</p>
                    <button @click="switchPage('expenses')" class="btn-primary">
                        <i class="fas fa-plus"></i>
                        Add Your First Expense
                    </button>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button @click="switchPage('dashboard')" :class="{ active: currentPage === 'dashboard' }" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </button>
            <button @click="switchPage('expenses')" :class="{ active: currentPage === 'expenses' }" class="nav-item">
                <i class="fas fa-list"></i>
                <span>Expenses</span>
            </button>
            <button @click="switchPage('analytics')" :class="{ active: currentPage === 'analytics' }" class="nav-item">
                <i class="fas fa-chart-bar"></i>
                <span>Analytics</span>
            </button>
        </nav>
    </div>
    <div id="error-container"></div> <!-- Container for error notifications -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/polyfill@7.12.1/dist/polyfill.min.js"></script> <!-- Polyfill for older browsers -->
    <script src="script.js"></script>
</body>
</html>
